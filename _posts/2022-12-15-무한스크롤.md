---
title: "ë¬´í•œìŠ¤í¬ë¡¤"
date: "2022-12-15 00:00:00"
categories: [FE, React]
tags: [react, scroll, infinite] # TAGëŠ” ë°˜ë“œì‹œ ì†Œë¬¸ìë¡œ ì´ë£¨ì–´ì ¸ì•¼í•¨!
---

## ğŸ“Œ ë¦¬ì•¡íŠ¸ ë¬´í•œìŠ¤í¬ë¡¤(infinite scroll) êµ¬í˜„í•˜ê¸°

### âœï¸ êµ¬í˜„ ë°©ë²•

1. Scroll Eventë¥¼ ê°ì§€í•˜ê³ , í•´ë‹¹ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ì—ì„œ ìŠ¤í¬ë¡¤ê°’ì„ ë¹„êµ
2. Javascriptì—ì„œ ì§€ì›í•˜ëŠ” Observer APIë¥¼ í™œìš©

## ğŸ“Œ Scroll Eventë¥¼ ê°ì§€í•˜ê³ , í•´ë‹¹ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ì—ì„œ ìŠ¤í¬ë¡¤ê°’ì„ ë¹„êµ

### âœï¸ MSW(Mock Service Worker)ë¥¼ ì´ìš©í•˜ì—¬ ê°€ìƒì˜ api ë§Œë“¤ê¸°

<a href="https://moonjh9392.github.io/posts/MSW/">https://moonjh9392.github.io/posts/MSW/</a>

src/mocks/handler.ts

```javascript
import { rest } from "msw";

// [ì½”ë“œ 1] ë¬´í•œìŠ¤í¬ë¡¤ ì‘ë‹µ ì¸í„°í˜ì´ìŠ¤
export interface PaginationResponse<T> {
  contents: T[];
  pageNumber: number;
  pageSize: number;
  totalPages: number;
  totalCount: number;
  isLastPage: boolean;
  isFirstPage: boolean;
}

export interface User {
  id: number;
  name: string;
}

// [ì½”ë“œ 2] MSW ìœ ì € ëª©ë¡ ëª¨í‚¹ API
//ë°ì´í„° ìƒì„±
const users = Array.from(Array(256).keys()).map((id): User => ({
  id,
  name: `denis${id}`,
}));

export const handlers = [
  //ë¬´í•œìŠ¤í¬ë¡¤ ì‘ë‹µë¶€
  rest.get("/users", async (req, res, ctx) => {
    const { searchParams } = req.url;
    const size = Number(searchParams.get("size"));
    const page = Number(searchParams.get("page"));

    const totalCount = users.length;
    const totalPages = Math.round(totalCount / size);

    return res(
      ctx.status(200),
      ctx.json <
        PaginationResponse <
        User >>
          {
            contents: users.slice(page * size, (page + 1) * size),
            pageNumber: page,
            pageSize: size,
            totalPages,
            totalCount,
            isLastPage: totalPages <= page,
            isFirstPage: page === 0,
          },
      ctx.delay(500)
    );
  }),
];
```

src/mocks/worker.js

```javascript
import { setupWorker } from "msw";
import { handlers } from "./handlers.ts";

export const worker = setupWorker(...handlers);
```

src/index.tsx

```javascript
import ...
...
//ì•„ë˜ì˜ ë‚´ìš© ì¶”ê°€
//MSW
import { worker } from './mocks/worker';
if (process.env.NODE_ENV === 'development') {
  worker.start();
}
...
```

MSWë¡œ /users apië¥¼ ë§Œë“¤ì–´ ë°ì´í„°ë¥¼ ë“¤ê³ ì˜¬ ìˆ˜ ìˆë„ë¡ ë§Œë“¤ì–´ì¤Œ

### âœï¸ ì„¤ëª…

src/components/UserPage.tsx

```javascript
import axios from 'axios';
import { useCallback, useEffect, useState } from 'react';

import styled from 'styled-components';
import { PaginationResponse, User } from '../mocks/handlers';
import Loading from './common/Loading';

// [ì½”ë“œ 3] Scroll eventë¥¼ ì´ìš©í•œ ë¬´í•œìŠ¤í¬ë¡¤ ì˜ˆì‹œ

//Card ì»´í¬ë„ŒíŠ¸ì˜ heigth ì‚¬ì´ì¦ˆ
export const CARD_SIZE = 50;
//visualViewport : ë·°í¬íŠ¸ ì‚¬ì´ì¦ˆ
//PAGE_SIZE : ë°ì´í„°ê°€ ëª‡ê°œì”© ë³´ì¼ì§€ ì •í•˜ëŠ” ë³€ìˆ˜
export const PAGE_SIZE = Math.ceil(visualViewport!.width / CARD_SIZE);

function UsersPage() {
  const [page, setPage] = useState(0);
  const [users, setUsers] = useState<User[]>([]);
  const [isFetching, setFetching] = useState(false);
  const [hasNextPage, setNextPage] = useState(true);

  const fetchUsers = useCallback(async () => {
    const { data } = await axios.get<PaginationResponse<User>>('/users', {
      params: { page, size: PAGE_SIZE },
    });
    //user data ì¶”ê°€
    setUsers(users.concat(data.contents));
    // í˜ì´ì§€ ì¶”ê°€
    setPage(data.pageNumber + 1);
    // ë§ˆì§€ë§‰ í˜ì´ì§€ ì¸ì§€ í™•ì¸
    setNextPage(!data.isLastPage);
    //isFetching : false ì´ˆê¸°í™”
    setFetching(false);
  }, [page]);

  //1. useEffectë¡œ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ìƒì„±
  useEffect(() => {
    const handleScroll = () => {
      console.log('handleScroll');

      //scrollTop : ìŠ¤í¬ë¡¤ ìœ„ì¹˜ px ë°˜í™˜
      //offsetHeight : ìš”ì†Œì˜ ë†’ì´
      const { scrollTop, offsetHeight } = document.documentElement;
      //innerHeight : ë·°í¬íŠ¸ ë†’ì´
      // ë°”ë‹¥ê°ì§€
      if (window.innerHeight + scrollTop >= offsetHeight) {
        //ë°”ë‹¥ì¼ ê²½ìš° isFetching ê°’ì„ true ë¡œ ë°”ê¿” ë°ì´í„°ë¥¼ ë“¤ê³ ì˜¨ë‹¤
        setFetching(true);
      }
    };
    //ì²˜ìŒ í˜ì´ì§€ ì™”ì„ë•Œ ë°ì´í„° get í•˜ê¸° ìœ„í•´ isFetching : trueë¡œ ë°”ê¿ˆ
    setFetching(true);
    window.addEventListener('scroll', handleScroll);
    return () => window.removeEventListener('scroll', handleScroll);
  }, []);

  //2. 1ë²ˆì—ì„œ isFetching ê°’ì´ ë°”ë€Œë©´ì„œ ì•„ë˜ì˜ ë©”ì„œë“œ ì‹¤í–‰
  useEffect(() => {
    //isFetching : ture , hasNextPage : true ì´ë©´ fetchUsers ì‹¤í–‰
    if (isFetching && hasNextPage) fetchUsers();
    else if (!hasNextPage) setFetching(false);
  }, [isFetching]);

  return (
    <Container>
      {users.map((user) => (
        <Card key={user.id} size={CARD_SIZE}>
          {user.name}
        </Card>
      ))}
      {isFetching && <Loading />}
    </Container>
  );
}

export const Container = styled.div`
  border: 1px solid black;
`;
export const Card = styled.div<{ size?: number }>`
  height: ${(props) => (props.size ? props.size + `px` : `50px`)};
  border: 1px solid black;
`;

export default UsersPage;

```

ìŠ¤í¬ë¡¤ì´ ë°”ë‹¥ì„ ê°ì§€í• ë•Œë§ˆë‹¤ fetchì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ í™”ë©´ì— ë¿Œë ¤ì¤€ë‹¤

![ezgif com-gif-maker (1)](https://user-images.githubusercontent.com/45509511/209632998-a5cea9c3-3c55-4403-b5aa-f079e999b513.gif)

ì´ë ‡ê²Œ í•˜ë©´ ìœ„ì˜ ì‚¬ì§„ì²˜ëŸ¼ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ê°€ ê³¼ë‹¤í•˜ê²Œ ë°œìƒë˜ëŠ”ë°

lodashì˜ throttleì„ ì´ìš©í•´ ì»¨íŠ¸ë¡¤ ê°€ëŠ¥í•˜ë‹¤.

```javascript
...
import { throttle } from 'lodash';
...
//1. useEffectë¡œ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ìƒì„±
  useEffect(() => {
    ...
    //ì²˜ìŒ í˜ì´ì§€ ì™”ì„ë•Œ ë°ì´í„° get í•˜ê¸° ìœ„í•´ isFetching : trueë¡œ ë°”ê¿ˆ
    setFetching(true);
    window.addEventListener('scroll', throttle(handleScroll, 500));//ì—¬ê¸°ì„œ ì“°ë¡œí‹€ ì‚¬ìš©
    return () => window.removeEventListener('scroll', handleScroll);
  }, []);
```

![ezgif com-gif-maker (3)](https://user-images.githubusercontent.com/45509511/209633054-06395010-9950-4cde-a483-d9b99fdbc2b0.gif)

ì‹œì—°ì‹œê°„ 500msë¥¼ ì£¼ì–´ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë°œìƒ íšŸìˆ˜ê°€ ë§ì´ ì¤„ì€ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

## ğŸ“Œ 2. Javascriptì—ì„œ ì§€ì›í•˜ëŠ” Observer APIë¥¼ í™œìš©

### âœï¸ Observer API

Observer patternì€ ê°ì²´ ìƒíƒœë³€í™”ë¥¼ ê´€ì°°í•˜ëŠ” ê´€ì°°ìë“¤(ì˜µì €ë²„)ì„ ë“±ë¡í•˜ì—¬ ìƒíƒœë³€í™”ê°€ ìˆì„ ë•Œë§ˆë‹¤ ê° ì˜µì €ë²„ì— ì•Œë¦¬ëŠ” íŒ¨í„´ì´ë‹¤.

ì´ ë…¼ë¦¬ì— ê¸°ë°˜í•œ Javascript ë‚´ì¥ APIê°€ Observer API ì¸ ê²ƒì´ë‹¤.

1. MutationObserver

DOM ë³€ê²½ì„ ê°ì§€í•˜ëŠ” ì˜µì €ë²„ì´ë‹¤. ìš”ì†Œì˜ ì‚½ì…, ìˆ˜ì •, ì‚­ì œ ë° ìì‹ìš”ì†Œê°€ ìˆ˜ì •ë˜ëŠ” ê²½ìš° ë“±ì„ ê°ì§€í•œë‹¤.

2. ResizeObserver

íƒ€ê²Ÿ ìš”ì†Œê°€ ë¦¬ì‚¬ì´ì§• ì´ë²¤íŠ¸ë¥¼ í†µí•´ í¬ê¸°ê°€ ë³€ê²½ë  ë•Œë¥¼ ê°ì§€í•˜ëŠ” ì˜µì €ë²„ë‹¤. ë°˜ì‘í˜•ìœ¼ë¡œ ë³´ì´ëŠ”ë° ìœ ìš©í•˜ë‹¤.

3. IntersectionObserver

íƒ€ê²Ÿ ìš”ì†Œì™€ ìƒìœ„ ìš”ì†Œ(í˜¹ì€ ìµœìƒìœ„ document)ì˜ viewport ì‚¬ì´ì— êµì°¨ì§€ì ì„ ë¹„ë™ê¸°ì ìœ¼ë¡œ ê´€ì°°í•œë‹¤.

íƒ€ê²Ÿìš”ì†Œê°€ í™”ë©´ì— ì–¼ë§ˆë‚˜ ë³´ì´ëŠ”ì§€ì— ë”°ë¼ ë‹¤ì–‘í•œ ì´ë²¤íŠ¸ë¥¼ ì¤„ ìˆ˜ ìˆë‹¤.

### âœï¸ ì‚¬ìš© ë°©ë²•

ì¸ìŠ¤í„´ìŠ¤ ìƒì„±

```javascript
let observer = new IntersectionObserver(callback, options);
```

- callback : êµì°¨ì‹œì— ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜ì´ë‹¤. ë¡œë”©êµ¬í˜„ì´ë‚˜ íŒ¨ì¹˜ ë“±ì˜ í•¨ìˆ˜ê°€ í†µìƒ í• ë‹¹ëœë‹¤.
- options : Intersection Observerì— ê´€í•œ ì„¤ì •ì„ í•  ìˆ˜ ìˆëŠ” ë¶€ë¶„ì´ë‹¤.
- root : êµì°¨ë¥¼ ê°ì§€í•˜ëŠ” root ìš”ì†Œ. observeë¡œ ë“±ë¡í•  ìš”ì†Œì˜ ìƒìœ„ìš”ì†Œì—¬ì•¼ í•œë‹¤. ê¸°ë³¸ê°’ì€ null(ì´ ë• ë¸Œë¼ìš°ì € viewport)
- rootMargin : root ìš”ì†Œì˜ ë§ˆì§„ê°’. ê¸°ë³¸ê°’ì€ 0px.
- threshold : 0.0 ~ 1.0 ì‚¬ì´ì˜ ìˆ«ìë“¤ì„ ë°°ì—´ë¡œ ë°›ëŠ”ë‹¤. ì´ëŠ” %ë¡œ ì¹˜í™˜ë˜ì–´, í•´ë‹¹ ë¹„ìœ¨ë§Œí¼ êµì°¨ëœ ê²½ìš° ì½œë°±ì´ ì‹¤í–‰ëœë‹¤.

### âœï¸ êµ¬í˜„

- react-queryì˜ useInfiniteQueryë¥¼ ì´ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ë“¤ê³ ì˜¬ê²ƒì´ê¸°ì— ì»¤ìŠ¤í…€ í›…ì„ ë§Œë“¤ì–´ì¤€ë‹¤
- observerë„ ë§ˆì°¬ê°€ì§€ë¡œ ì»¤ìŠ¤í…€ í›…ì„ ì´ìš©í•˜ì—¬ ë§Œë“¤ì–´ì¤Œ

1. src/hooks/useFetchUsers.ts

```javascript
import axios from 'axios';
import { QueryFunctionContext, useInfiniteQuery } from 'react-query';
import { PaginationResponse, User } from '../mocks/handlers';

interface PaginationParams {
  size: number | null;
}

// [ì½”ë“œ 12] React Queryë¥¼ ì´ìš©í•œ ìœ ì € ëª©ë¡ API í˜¸ì¶œ í•¨ìˆ˜
//ê³ ìœ  í‚¤ê°’ ë§Œë“œëŠ”ë° ì‚¬ìš©ë¨ detail ì™œìˆëŠ”ì§€ ëª¨ë¦„ kakaoêº¼ ê¸ì–´ì™”ìŒ
export const userKeys = {
  all: ['users'] as const,
  lists: () => [...userKeys.all, 'list'] as const,
  list: (filters: string) => [...userKeys.lists(), { filters }] as const,
  details: () => [...userKeys.all, 'detail'] as const,
  detail: (id: number) => [...userKeys.details(), id] as const,
};

export const useFetchUsers = ({ size }: PaginationParams) => {
  console.log('useFetchUsers');
  //useInfiniteQuery : 'react-query' ì—ì„œ ë¬´í•œìŠ¤í¬ë¡¤ì„ ì‚¬ìš©í•˜ê¸°ìœ„í•´ ë§Œë“  ë©”ì„œë“œ
  //useInfiniteQuery(queryKey,queryFn,...)
  //queryKey :  useQueryë§ˆë‹¤ ë¶€ì—¬ë˜ëŠ” ê³ ìœ  Key, React Queryê°€ query ìºì‹±ì„ ê´€ë¦¬í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì¤ë‹ˆë‹¤.
  //queryFn : query Functionìœ¼ë¡œ promise ì²˜ë¦¬ê°€ ì´ë£¨ì–´ì§€ëŠ” í•¨ìˆ˜
  return useInfiniteQuery(
    //queryKey
    //['users','list']
    userKeys.lists(),
    //queryFn
    //pageParam : useInfiniteQueryê°€ í˜„ì¬ ì–´ë–¤ í˜ì´ì§€ì— ìˆëŠ”ì§€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆëŠ” íŒŒë¼ë¯¸í„° ê°’
    ({ pageParam = 0 }: QueryFunctionContext) => {
      //data get
      return axios.get<PaginationResponse<User>>('/users', {
        params: { page: pageParam, size },
      });
    },
    {
      //getNextPageParamê³¼ fetchNextPageì€ ê³µí†µì ìœ¼ë¡œ ë‹¤ìŒ í˜ì´ì§€ì— ìˆëŠ” ë°ì´í„°ë¥¼ ì¡°íšŒí•´ì˜¬ ë•Œ ì‚¬ìš©ë©ë‹ˆë‹¤.
      //getNextPageParam : ë‹¤ìŒ apië¥¼ ìš”ì²­í•  ë•Œ ì‚¬ìš©ë  pageParamê°’ì„ ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      //getNextPageParam : undefinedê°€ ì•„ë‹Œ ë‹¤ë¥¸ê°’ì„ ë°˜í™˜ í•  ê²½ìš° hasNextPage : true
      //ë§ˆì§€ë§‰ í˜ì´ì§€ê°€ ì•„ë‹ê²½ìš° pageParam += 1
      //fetchNextPage : ë‹¤ìŒ í˜ì´ì§€ì˜ ë°ì´í„°ë¥¼ í˜¸ì¶œí•  ë•Œ ì‚¬ìš© useInfiniteQueryì˜ returnì— í¬í•¨ë¨
      //fetchNextPageë¥¼ ì´ìš©í•´ í˜¸ì¶œëœ ë°ì´í„°ëŠ” ë°°ì—´ì˜ ê°€ì¥ ìš°ì¸¡ì— ìƒˆë¡­ê²Œ ë‹´ê²¨ ì „ë‹¬ë¨
      getNextPageParam: ({ data: { isLastPage, pageNumber } }) => (isLastPage ? undefined : pageNumber + 1),
    }
  );
};

```

2. src/hooks/useIntersect.ts

```javascript
import { useCallback, useEffect, useRef } from "react";

// [ì½”ë“œ 11] IntersectionObserver custom hook
export type IntersectHandler = (
  entry: IntersectionObserverEntry,
  observer: IntersectionObserver
) => void;

export const useIntersect = (
  onIntersect: IntersectHandler,
  options?: IntersectionObserverInit
) => {
  console.log("useIntersect");
  const ref = useRef < HTMLDivElement > null;
  const callback = useCallback(
    //entries : IntersectionObserverEntry ì¸ìŠ¤í„´ìŠ¤ì˜ ë°°ì—´
    (entries: IntersectionObserverEntry[], observer: IntersectionObserver) => {
      entries.forEach((entry) => {
        //isIntersecting : ëŒ€ìƒ ìš”ì†Œê°€ êµì°¨ ê´€ì°°ìì˜ ë£¨íŠ¸ì™€ êµì°¨í•˜ëŠ” ê²½ìš°
        //ì—¬ê¸°ì„œëŠ” ëŒ€ìƒ ìš”ì†Œê°€ target ì»´í¬ë„ŒíŠ¸ì™€ êµì°¨í•˜ëŠ” ê²½ìš° onIntersectí•¨ìˆ˜ í˜¸ì¶œ
        //onIntersect => ê°’ì—ë”°ë¼ ë°ì´í„° ë“¤ê³ ì˜´
        if (entry.isIntersecting) onIntersect(entry, observer);
      });
    },
    [onIntersect]
  );

  useEffect(() => {
    //ref = UserPage2ì— ë§¨ë°‘ì˜ target ì»´í¬ë„ŒíŠ¸
    if (!ref.current) return;
    //observer ì„ ì–¸
    const observer = new IntersectionObserver(callback, options);
    //target ì»´í¬ë„ŒíŠ¸ì— ê´€ì°°ì ë“±ë¡
    observer.observe(ref.current);
    return () => observer.disconnect();
  }, [ref, options, callback]);

  return ref;
};
```

3. src/components/UserPage2

```javascript
import { useMemo } from "react";
import styled from "styled-components";
import { useFetchUsers } from "../hooks/useFetchUsers";
import { useIntersect } from "../hooks/useIntersect";
import Loading from "./common/Loading";
//1ë²ˆ ë°©ë²•ì—ì„œ export í•˜ì—¬ ë“¤ê³ ì˜´
import { Card, CARD_SIZE, Container, PAGE_SIZE } from "./UsersPage";

// [ì½”ë“œ 13] IntersectionObserver ì ìš©í•œ ìµœì¢… ì˜ˆì‹œ
export function UsersPage2() {
  const { data, hasNextPage, isFetching, fetchNextPage } = useFetchUsers({
    size: PAGE_SIZE,
  });

  //flatMap : ê° ì—˜ë¦¬ë¨¼íŠ¸ì— ëŒ€í•´ map ìˆ˜í–‰ í›„, ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ ë°°ì—´ë¡œ í‰íƒ„í™”í•¨
  const users = useMemo(
    () => (data ? data.pages.flatMap(({ data }) => data.contents) : []),
    [data]
  );

  const ref = useIntersect(
    //entry
    async (entry, observer) => {
      //ê´€ì°° ì¤‘ë‹¨
      observer.unobserve(entry.target);
      //ë‹¤ìŒí˜ì´ì§€ê°€ ìˆê³  isFetching : false ì´ë©´ ë°ì´í„° ë“¤ê³ ì˜´
      if (hasNextPage && !isFetching) {
        fetchNextPage();
      }
    },
    //options
    //root : ê¸°ë³¸ê°’ null = ë¸Œë¼ìš°ì € ë·°í¬íŠ¸
    //rootMargin : root ìš”ì†Œì˜ ë§ˆì§„ê°’. ê¸°ë³¸ê°’ì€ 0px.
    //threshold : 0.0 ~ 1.0 ì‚¬ì´ì˜ ìˆ«ìë“¤ì„ ë°°ì—´ë¡œ ë°›ëŠ”ë‹¤. ì´ëŠ” %ë¡œ ì¹˜í™˜ë˜ì–´, í•´ë‹¹ ë¹„ìœ¨ë§Œí¼ êµì°¨ëœ ê²½ìš° ì½œë°±ì´ ì‹¤í–‰ëœë‹¤.
    { root: null, rootMargin: "0px", threshold: 1.0 }
  );

  return (
    <Container>
      {users.map((user) => (
        <Card key={user.id} size={CARD_SIZE}>
          {user.name}
        </Card>
      ))}
      {isFetching && <Loading />}
      <Target ref={ref} />
    </Container>
  );
}
const Target = styled.div`
  height: 1px;
`;
```

4. UserPage2 ì»´í¬ë„ŒíŠ¸ë¥¼ ì‚¬ìš©í•˜ëŠ”ê³³ì— ë‚´ìš© ì¶”ê°€

```javascript
import { QueryClient, QueryClientProvider, useQuery } from 'react-query';

const queryClient = new QueryClient();
...

  <QueryClientProvider client={queryClient}>
    <UsersPage2 />
  </QueryClientProvider>
```

![ezgif com-gif-maker (2)](https://user-images.githubusercontent.com/45509511/209633090-131d981c-438d-42d5-aad0-90d29798f9de.gif)

### âœï¸ ì°¸ê³ 

ì¹´ì¹´ì˜¤ ì—”í„°í”„ë¼ì´ì¦ˆ í…Œí¬ì‚¬ì´íŠ¸

<a href='https://tech.kakaoenterprise.com/149'>https://tech.kakaoenterprise.com/149</a>

ì˜ˆì œ

<a href='https://github.com/moonjh9392/infiniteScroll'>https://github.com/moonjh9392/infiniteScroll</a>
